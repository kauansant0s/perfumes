<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Diagn√≥stico - Perfumes</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
            max-width: 1200px;
            margin: 0 auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        pre {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            overflow-x: auto;
        }
        button {
            background: #C06060;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #a85050;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #2d2d2d;
            border-radius: 8px;
        }
        h2 {
            color: #C06060;
            margin-top: 0;
        }
        .perfume-item {
            background: #3d3d3d;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #C06060;
        }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico Completo do Sistema</h1>
    
    <div class="section">
        <h2>1. Estado da Autentica√ß√£o</h2>
        <div id="auth-status">Verificando...</div>
    </div>
    
    <div class="section">
        <h2>2. Perfumes no Firestore</h2>
        <button onclick="listarTodosPerfumes()">Listar TODOS os Perfumes</button>
        <button onclick="listarPerfumesUsuario()">Listar Perfumes do Usu√°rio Logado</button>
        <div id="perfumes-list"></div>
    </div>
    
    <div class="section">
        <h2>3. Estrutura dos Perfumes</h2>
        <div id="estrutura-perfumes"></div>
    </div>
    
    <div class="section">
        <h2>4. Marcas Cadastradas</h2>
        <button onclick="listarMarcas()">Listar Marcas</button>
        <button onclick="testarSalvarMarca()">Testar Salvar Marca</button>
        <div id="marcas-list"></div>
    </div>
    
    <div class="section">
        <h2>5. A√ß√µes de Corre√ß√£o</h2>
        <button onclick="adicionarUserIdPerfumes()">Adicionar userId aos Perfumes</button>
        <button onclick="migrarMarcas()">Migrar Marcas</button>
        <div id="acoes-result"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCWuG4gVnf6r2JVBJX4k6a5kwM_Jf3cw8c",
          authDomain: "meus-pefumes.firebaseapp.com",
          projectId: "meus-pefumes",
          storageBucket: "meus-pefumes.firebasestorage.app",
          messagingSenderId: "5138203233",
          appId: "1:5138203233:web:b684d4397c4ffefa572020"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        
        // Verifica autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            const authStatus = document.getElementById('auth-status');
            if (user) {
                currentUser = user;
                authStatus.innerHTML = `
                    <div class="success">‚úÖ Usu√°rio Logado</div>
                    <div class="info">Email: ${user.email}</div>
                    <div class="info">UID: ${user.uid}</div>
                    <div class="info">Nome: ${user.displayName || 'N√£o definido'}</div>
                `;
            } else {
                authStatus.innerHTML = `
                    <div class="error">‚ùå Nenhum usu√°rio logado</div>
                    <div class="warning">Fa√ßa login primeiro em <a href="../login/login.html" style="color:#C06060;">login.html</a></div>
                `;
            }
        });
        
        // Lista TODOS os perfumes
        window.listarTodosPerfumes = async function() {
            const div = document.getElementById('perfumes-list');
            div.innerHTML = '<div class="info">Buscando perfumes...</div>';
            
            try {
                const querySnapshot = await getDocs(collection(db, "perfumes"));
                
                if (querySnapshot.empty) {
                    div.innerHTML = '<div class="warning">‚ö†Ô∏è Nenhum perfume encontrado no Firestore!</div>';
                    return;
                }
                
                let html = `<div class="success">‚úÖ Total de perfumes: ${querySnapshot.size}</div>`;
                
                querySnapshot.forEach((doc) => {
                    const perfume = doc.data();
                    const temUserId = perfume.userId ? '‚úÖ' : '‚ùå';
                    
                    html += `
                        <div class="perfume-item">
                            <strong>${perfume.nome || 'Sem nome'}</strong> - ${perfume.marca || 'Sem marca'}<br>
                            <small>ID: ${doc.id}</small><br>
                            <small>Status: ${perfume.status || 'N√£o definido'}</small><br>
                            <small>UserId: ${temUserId} ${perfume.userId || 'N√ÉO TEM'}</small>
                        </div>
                    `;
                });
                
                div.innerHTML = html;
                
                // Mostra estrutura do primeiro perfume
                const primeiro = querySnapshot.docs[0].data();
                document.getElementById('estrutura-perfumes').innerHTML = `
                    <div class="info">Estrutura do primeiro perfume:</div>
                    <pre>${JSON.stringify(primeiro, null, 2)}</pre>
                `;
                
            } catch (error) {
                div.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
                console.error(error);
            }
        };
        
        // Lista perfumes do usu√°rio logado
        window.listarPerfumesUsuario = async function() {
            if (!currentUser) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            
            const div = document.getElementById('perfumes-list');
            div.innerHTML = '<div class="info">Buscando perfumes do usu√°rio...</div>';
            
            try {
                const q = query(
                    collection(db, "perfumes"),
                    where("userId", "==", currentUser.uid)
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    div.innerHTML = `
                        <div class="warning">‚ö†Ô∏è Nenhum perfume encontrado para o usu√°rio ${currentUser.email}</div>
                        <div class="info">UID buscado: ${currentUser.uid}</div>
                        <div class="info">Isso pode significar que os perfumes n√£o t√™m o campo userId!</div>
                    `;
                    return;
                }
                
                let html = `<div class="success">‚úÖ Perfumes do usu√°rio: ${querySnapshot.size}</div>`;
                
                querySnapshot.forEach((doc) => {
                    const perfume = doc.data();
                    html += `
                        <div class="perfume-item">
                            <strong>${perfume.nome}</strong> - ${perfume.marca}<br>
                            <small>Status: ${perfume.status}</small>
                        </div>
                    `;
                });
                
                div.innerHTML = html;
                
            } catch (error) {
                div.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
                console.error(error);
            }
        };
        
        // Adiciona userId a perfumes que n√£o t√™m
        window.adicionarUserIdPerfumes = async function() {
            if (!currentUser) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            
            if (!confirm('Isso vai adicionar seu userId a TODOS os perfumes que n√£o t√™m. Continuar?')) {
                return;
            }
            
            const div = document.getElementById('acoes-result');
            div.innerHTML = '<div class="info">Processando...</div>';
            
            try {
                const querySnapshot = await getDocs(collection(db, "perfumes"));
                let atualizados = 0;
                let total = 0;
                
                for (const docSnap of querySnapshot.docs) {
                    const perfume = docSnap.data();
                    total++;
                    
                    if (!perfume.userId) {
                        await updateDoc(doc(db, "perfumes", docSnap.id), {
                            userId: currentUser.uid
                        });
                        atualizados++;
                        console.log(`Atualizado: ${perfume.nome}`);
                    }
                }
                
                div.innerHTML = `
                    <div class="success">‚úÖ Processo conclu√≠do!</div>
                    <div class="info">Total de perfumes: ${total}</div>
                    <div class="info">Perfumes atualizados: ${atualizados}</div>
                `;
                
            } catch (error) {
                div.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
                console.error(error);
            }
        };
        
        // Migra marcas
        window.migrarMarcas = async function() {
            const div = document.getElementById('acoes-result');
            div.innerHTML = '<div class="info">Migrando marcas...</div>';
            
            try {
                const perfumesSnapshot = await getDocs(collection(db, "perfumes"));
                const marcasUnicas = new Set();
                
                perfumesSnapshot.forEach((doc) => {
                    const perfume = doc.data();
                    if (perfume.marca && perfume.marca.trim() !== '') {
                        marcasUnicas.add(perfume.marca.trim());
                    }
                });
                
                let salvadas = 0;
                for (const marca of marcasUnicas) {
                    const q = query(collection(db, "marcas"), where("nome", "==", marca));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        await addDoc(collection(db, "marcas"), {
                            nome: marca,
                            dataCriacao: serverTimestamp()
                        });
                        salvadas++;
                    }
                }
                
                div.innerHTML = `
                    <div class="success">‚úÖ Migra√ß√£o conclu√≠da!</div>
                    <div class="info">Marcas encontradas: ${marcasUnicas.size}</div>
                    <div class="info">Marcas novas salvas: ${salvadas}</div>
                `;
                
            } catch (error) {
                div.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
                console.error(error);
            }
        };
        
        // Lista marcas
        window.listarMarcas = async function() {
            const div = document.getElementById('marcas-list');
            div.innerHTML = '<div class="info">Buscando marcas...</div>';
            
            try {
                const querySnapshot = await getDocs(collection(db, "marcas"));
                
                if (querySnapshot.empty) {
                    div.innerHTML = '<div class="warning">‚ö†Ô∏è Nenhuma marca cadastrada ainda</div>';
                    return;
                }
                
                const marcas = [];
                querySnapshot.forEach((doc) => {
                    marcas.push(doc.data().nome);
                });
                
                marcas.sort();
                
                div.innerHTML = `
                    <div class="success">‚úÖ Total de marcas: ${marcas.length}</div>
                    <div class="info">${marcas.join(', ')}</div>
                `;
                
            } catch (error) {
                div.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
                console.error(error);
            }
        };
    </script>
</body>
</html>